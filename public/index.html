<!DOCTYPE html>
<html>
<head>
    <title>Real Estate Assistant</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .chat-container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .chat-header { background: #2563eb; color: white; padding: 20px; text-align: center; }
        .chat-messages { height: 400px; overflow-y: auto; padding: 20px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 70%; }
        .user-message { background: #e5e7eb; margin-left: auto; }
        .assistant-message { background: #dbeafe; }
        .chat-input { display: flex; padding: 20px; gap: 10px; border-top: 1px solid #e5e7eb; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; }
        .chat-input button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .voice-button { background: #dc2626; }
        .loading { opacity: 0.7; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>üè† Real Estate Assistant</h1>
            <p>Find your perfect property in Qatar</p>
        </div>
        <div class="chat-messages" id="messages"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Ask about properties, prices, locations..." />
            <button onclick="sendMessage()">Send</button>
            <button class="voice-button" onclick="toggleRecording()">üé§</button>
        </div>
    </div>

    <h1>Upload Documents</h1>
  <form id="uploadForm">
    <input type="file" name="file" required />
    <button type="submit">Upload</button>
  </form>

  <h2>Uploaded Files</h2>
  <ul id="fileList"></ul>
</body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

  <script>
    import * as pdfjsLib from "pdfjs-dist";
    import * as mammoth from "mammoth/mammoth.browser";

    const uploadForm = document.getElementById('uploadForm');
    const fileList = document.getElementById('fileList');

    // --- Extract text depending on type ---
  async function extractText(file) {
    if (file.type === "application/pdf") {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map((s) => s.str).join(" ") + "\n\n";
      }
      return text;
    } else if (
      file.type ===
      "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    ) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await window.mammoth.extractRawText({ arrayBuffer });
      return result.value;
    } else {
      // Fallback for txt or unknown
      return await file.text();
    }
  }
    // // Handle upload
    // uploadForm.addEventListener('submit', async (e) => {
    //   e.preventDefault();
    //   const formData = new FormData(uploadForm);
    //   const res = await fetch('http://localhost:8787/upload', { method: 'POST', body: formData });
    //   const result = await res.json();
    //   alert(result.status || result.error);
    //   uploadForm.reset();
    //   loadFiles();
    // });

    // --- Handle upload ---
  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const file = uploadForm.elements.file.files[0]; // <--- use form.elements
    if (!file) {
      alert("Please choose a file");
      return;
    }

    const text = await extractText(file);

    // Wrap extracted text as if it were a file
    const formData = new FormData();
    formData.append("file", new Blob([text], { type: "text/plain" }), file.name);

    const res = await fetch("http://localhost:8787/upload", {
      method: "POST",
      body: formData,
    });

    const result = await res.json();
    alert(result.status || result.error);
    uploadForm.reset();
    loadFiles();
  });


    // Fetch uploaded files
    async function loadFiles() {
      const res = await fetch('http://localhost:8787/files' ,{ method: 'GET'});
      const files = await res.json();
      fileList.innerHTML = '';
      files.forEach(file => {
        const li = document.createElement('li');

        const link = document.createElement('a');
        link.href = `/view/${file.id}`;
        link.target = "_blank";
        link.textContent = file.filename;

        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (confirm(`Delete ${file.filename}?`)) {
            const res = await fetch(`http://localhost:8787/delete/${file.id}`, { method: 'DELETE' });
            const result = await res.json();
            alert(result.message || result.error);
            loadFiles();
          }
        };

        li.appendChild(link);
        li.appendChild(delBtn);
        fileList.appendChild(li);
      });
    }

    // Initial load
    loadFiles();
  </script>

    <script>
        let sessionId = localStorage.getItem('sessionId') || generateId();
        localStorage.setItem('sessionId', sessionId);
        
        // let userId = localStorage.getItem('userId') || generateId();
        const userId = crypto.randomUUID();
        // localStorage.setItem('userId', userId);
        
        let recording = false;
        let mediaRecorder;
        let audioChunks = [];
        
        function generateId() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }
        
        async function sendMessage(audioData = null) {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !audioData) return;
            
            // Add user message to chat
            if (message) {
                addMessage(message, 'user');
                input.value = '';
            }
            
            // Show loading
            const loadingId = addMessage('Thinking...', 'assistant', true);
            
            try {

                const response = await fetch('http://localhost:8787/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message || null,
                        sessionId,
                        userId,
                        audioData
                    })
                });
                
                const data = await response.json();
                
                // Remove loading message
                const loadingElem = document.getElementById(loadingId);
                if (loadingElem)  loadingElem.remove();
                // Add assistant response
                if (!data.transcription){
                addMessage(data.response, 'assistant');
                }
                // Update session ID if new
                if (data.sessionId !== sessionId) {
                    sessionId = data.sessionId;
                    localStorage.setItem('sessionId', sessionId);
                }
                
                // Show transcription if audio was used
                if (data.transcription && !message) {
                    addMessage(`üé§ "${data.transcription}"`, 'user');
                    addMessage(data.response, 'assistant');
                }
                
            } catch (error) {
                const loadingElem = document.getElementById(loadingId);
                if (loadingElem) loadingElem.remove();
                addMessage('Sorry, something went wrong. Please try again.', 'assistant');
                console.error('Error:', error);
            }
        }
        
        function addMessage(text, sender, isLoading = false) {
            const messages = document.getElementById('messages');
            console.log('Adding message:', text);
            const messageDiv = document.createElement('div');
            const id = 'msg-' + Date.now();
            
            messageDiv.id = id;
            messageDiv.className = `message ${sender}-message ${isLoading ? 'loading' : ''}`;
            messageDiv.innerHTML = formatMessage(text);
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
            
            return id;
        }
        
        function formatMessage(text) {
            // Simple formatting for property listings
            return text
                .replace(/‚Ä¢/g, ' ‚Ä¢')
                .replace(/\n/g, '<br>')
                .replace(/(\w+)\s*‚Ä¢\s*(\d+)\s*BR\s*‚Ä¢\s*(\d+)\s*Bath\s*‚Ä¢\s*(\d+)\s*sqm\s*‚Ä¢\s*(\d+)\s*QAR/gi, 
                    '<strong>$1</strong> ‚Ä¢ $2 BR ‚Ä¢ $3 Bath ‚Ä¢ $4 sqm ‚Ä¢ <strong>$5 QAR</strong>');
        }
        
        // Voice recording
        async function toggleRecording() {
            if (!recording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }
        // In utils.js
       
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                resolve(reader.result.split(',')[1]); // Base64 without the "data:..." prefix
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
            }


        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioData = await blobToBase64(audioBlob);
                    await sendMessage(audioData);
                };
                
                mediaRecorder.start();
                recording = true;
                document.querySelector('.voice-button').textContent = '‚èπÔ∏è';
                document.querySelector('.voice-button').style.background = '#dc2626';
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not record audio. Please check your microphone permissions.');
            }
        }

        function stopRecording() {
    if (mediaRecorder && recording) {
        mediaRecorder.stop();   // This triggers onstop event
        recording = false;
        document.querySelector('.voice-button').textContent = 'üé§';
        document.querySelector('.voice-button').style.background = '#2563eb';
    }
}

    </script>
    